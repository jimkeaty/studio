rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // --- Helper Functions ---
    function isSignedIn() {
      return request.auth != null;
    }

    function isAdmin() {
      // In a real application, this might be a custom claim or a read from an admin collection.
      // For now, hardcode a list of admin UIDs.
      // IMPORTANT: Replace with actual admin UIDs.
    let adminUids = [
  "1kJsXTU1JjZXMidmoIPXgXxizll1"
];
      return isSignedIn() && request.auth.uid in adminUids;
    }

    function isEditableYear(year) {
      return year >= 2025;
    }

    // --- User Data: Allow users to write to their own docs ---
    match /users/{userId}/{document=**} {
       allow read, write: if isSignedIn() && request.auth.uid == userId;
    }
    match /dashboards/{userId}/{document=**} {
       allow read, write: if isSignedIn() && request.auth.uid == userId;
    }

    // --- Activity & Transaction Data ---
    // Users can read/write their own activity logs.
    match /daily_activity/{activityId} {
      allow get: if isSignedIn() && resource.data.agentId == request.auth.uid;
      allow create: if isSignedIn() && request.resource.data.agentId == request.auth.uid;
      allow update: if isSignedIn() && resource.data.agentId == request.auth.uid;
      allow delete: if false; // Deletes are not a feature.

      // Allow listing, but require the client to filter by agentId for security.
      allow list: if isSignedIn();
    }

    // Users can C-R-D their own appointment logs, which have auto-generated IDs.
    match /appointment_logs/{logId} {
      allow create: if isSignedIn() && request.resource.data.agentId == request.auth.uid;
      // Split read into get and list for correctness.
      allow get, delete: if isSignedIn() && resource.data.agentId == request.auth.uid;
      // The client query MUST include `where('agentId', '==', uid)`.
      allow list: if isSignedIn();
      allow update: if false; // No updates are performed on appointment logs.
    }
    
    // Users can only read their own transactions for value metric calculations.
    // Writes are handled by an admin process (or a future dedicated feature).
    match /transactions/{transactionId} {
      // Rule for single document reads (get).
      allow get: if isSignedIn() && resource.data.agentId == request.auth.uid;
      // Rule for collection queries (list).
      // The client query MUST include `where('agentId', '==', uid)`.
      allow list: if isSignedIn();
      allow write: if false;
    }

    match /agentYearRollups/{docId} {
  // This collection must be public for the leaderboard and Top Agents components.
  allow read: if true;

  // Creates: only allow rollups for 2025+
  allow create: if isAdmin()
                && isEditableYear(request.resource.data.year);

  // Updates: both existing and incoming must be 2025+ (prevents spoofing)
  allow update: if isAdmin()
                && isEditableYear(resource.data.year)
                && isEditableYear(request.resource.data.year);

  allow delete: if false;
}
    match /historical_overrides/{overrideId} {
      allow read: if isSignedIn(); // Dashboards and admin tools need to read this.
      allow write: if isAdmin();   // Only admins can create, update, or deactivate overrides.
    }
    match /historical_corrections/{correctionId} {
      allow read: if isAdmin(); // Only admins need to read the audit trail.
      allow create: if isAdmin();  // Append-only, no updates or deletes.
      allow update, delete: if false;
    }

    // Default catch-all denies all other access
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
